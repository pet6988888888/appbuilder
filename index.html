<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Builder - Create Your Own Fitness App</title>
    <meta name="description" content="Build your own follow-along workout app with timers, videos, and exercises. Export as standalone HTML to embed anywhere.">
    <script src="https://cdn.tailwindcss.com">
// Copy exported HTML code
document.getElementById('copy-export-btn')?.addEventListener('click', async () => {
    const workouts = [];
    const processGroup = (group, groupName) => {
        group.workouts.forEach(w => {
            workouts.push({
                id: w.id,
                name: w.name,
                group: groupName,
                target: w.target,
                duration: calculateWorkoutDuration(w.exercises),
                icon: w.icon,
                exercises: w.exercises.map(e => ({
                    name: e.name,
                    type: e.type,
                    duration: e.duration,
                    videoUrl: e.videoUrl || '',
                    imageUrl: e.imageUrl || ''
                }))
            });
        });
        group.subGroups.forEach(sg => processGroup(sg, `${groupName} > ${sg.name}`));
    };
    state.groups.forEach(g => processGroup(g, g.name));
    const htmlText = generateExportedHTML(workouts);
    try {
        await navigator.clipboard.writeText(htmlText);
        alert("Code copied to clipboard!");
    } catch (err) {
        alert("Failed to copy.");
    }
});


// Modal handlers
const exportModal = document.getElementById('export-modal');
document.getElementById('export-modal-btn')?.addEventListener('click', () => {
    const workouts = [];
    const processGroup = (group, groupName) => {
        group.workouts.forEach(w => {
            workouts.push({
                id: w.id, name: w.name, group: groupName, target: w.target,
                duration: calculateWorkoutDuration(w.exercises),
                icon: w.icon,
                exercises: w.exercises.map(e => ({name: e.name, type: e.type, duration: e.duration, videoUrl: e.videoUrl||'', imageUrl: e.imageUrl||''}))
            });
        });
        group.subGroups.forEach(sg => processGroup(sg, `${groupName} > ${sg.name}`));
    };
    state.groups.forEach(g => processGroup(g, g.name));
    const html = generateExportedHTML(workouts);
    document.getElementById('export-html-code').value = html;
    exportModal.classList.remove('hidden');
});

document.getElementById('close-export-modal').onclick = () => exportModal.classList.add('hidden');

document.getElementById('copy-export-code').onclick = async () => {
    try { await navigator.clipboard.writeText(document.getElementById('export-html-code').value); alert("Copied!"); }
    catch(e){ alert("Copy failed"); }
};

document.getElementById('download-export-html').onclick = () => {
    const blob = new Blob([document.getElementById('export-html-code').value], {type:'text/html'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "workout_app.html";
    link.click();
};

</script>
    <style>
        .big-timer { font-size: 4rem; line-height: 1; }
        .big-timer.seconds-only { font-size: 5rem; }
        .progress-circle { transition: stroke-dashoffset 0.3s ease; }
        .color-picker-wrapper { position: relative; }
        .color-picker-wrapper input[type="color"] { 
            -webkit-appearance: none; 
            border: none; 
            width: 40px; 
            height: 40px; 
            cursor: pointer;
            border-radius: 8px;
            padding: 0;
        }
        .color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker-wrapper input[type="color"]::-webkit-color-swatch { border: 2px solid #374151; border-radius: 6px; }
        .preview-frame { 
            transform-origin: top left;
            border: 2px solid #4B5563;
            border-radius: 12px;
            overflow: hidden;
        }
        .nested-group { margin-left: 24px; border-left: 2px solid #4B5563; padding-left: 16px; }
        .edit-input { 
            background: transparent; 
            border: 1px solid #6366f1; 
            border-radius: 4px; 
            padding: 4px 8px; 
            color: white;
            outline: none;
        }
        .edit-input:focus { border-color: #818cf8; }
        .tab-active { background: #4f46e5; color: white; }
        .tab-inactive { background: #374151; color: #9ca3af; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.open { max-height: 2000px; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        const state = {
            view: 'builder', // 'builder' or 'preview'
            activeTab: 'structure', // 'structure' or 'colors'
            groups: [
                {
                    id: 'group-1',
                    name: 'Full Body',
                    isEditing: false,
                    isExpanded: true,
                    subGroups: [],
                    workouts: [
                        {
                            id: 'workout-1',
                            name: 'Morning Energizer',
                            target: 'Full Body Activation',
                            duration: '15 min',
                            icon: 'Dumbbell',
                            isEditing: false,
                            isExpanded: true,
                            exercises: [
                                { id: 'ex-1', name: 'Jumping Jacks', type: 'exercise', duration: 45, isEditing: false, videoUrl: '', imageUrl: '' },
                                { id: 'ex-2', name: 'Rest', type: 'rest', duration: 15, isEditing: false, videoUrl: '', imageUrl: '' },
                                { id: 'ex-3', name: 'Push-ups', type: 'exercise', duration: 30, isEditing: false, videoUrl: '', imageUrl: '' },
                                { id: 'ex-4', name: 'Rest', type: 'rest', duration: 15, isEditing: false, videoUrl: '', imageUrl: '' },
                                { id: 'ex-5', name: 'Squats', type: 'exercise', duration: 45, isEditing: false, videoUrl: '', imageUrl: '' }
                            ]
                        }
                    ]
                }
            ],
            colors: {
                background: '#030712',
                cardBackground: '#1f2937',
                primaryColor: '#4f46e5',
                secondaryColor: '#10b981',
                textColor: '#f3f4f6',
                accentColor: '#f59e0b'
            },
            appSettings: {
                appLogoUrl: '',
                appName: 'My Workout App',
                appDescription: 'Your personal fitness companion'
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        const generateId = () => 'id-' + Math.random().toString(36).substr(2, 9);

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        const calculateWorkoutDuration = (exercises) => {
            const totalSeconds = exercises.reduce((sum, ex) => sum + ex.duration, 0);
            const mins = Math.floor(totalSeconds / 60);
            return `${mins} min`;
        };

        const getAllWorkouts = () => {
            const workouts = [];
            const processGroup = (group, groupPath = '') => {
                const currentPath = groupPath ? `${groupPath} > ${group.name}` : group.name;
                group.workouts.forEach(w => {
                    workouts.push({ ...w, group: group.name, groupPath: currentPath });
                });
                group.subGroups.forEach(sg => processGroup(sg, currentPath));
            };
            state.groups.forEach(g => processGroup(g));
            return workouts;
        };

        // ==================== RENDER FUNCTIONS ====================
        const render = () => {
            const app = document.getElementById('app');
            if (state.view === 'builder') {
                app.innerHTML = renderBuilder();
            } else {
                app.innerHTML = renderFullPreview();
            }
            attachEventListeners();
        };

        const renderBuilder = () => {
            return `
                <div class="flex flex-col lg:flex-row min-h-screen">
                    <!-- Left Panel: Builder -->
                    <div class="w-full lg:w-1/2 p-4 lg:p-6 overflow-y-auto border-r border-gray-800">
                        <header class="mb-6">
                            <h1 class="text-3xl font-extrabold text-white flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.596 12.768a2 2 0 1 0 2.829-2.829l-1.768-1.767a2 2 0 0 0 2.828-2.829l-2.828-2.828a2 2 0 0 0-2.829 2.828l-1.767-1.768a2 2 0 1 0-2.829 2.829z"/><path d="m2.5 21.5 1.4-1.4"/><path d="m20.1 3.9 1.4-1.4"/><path d="M5.343 21.485a2 2 0 1 0 2.829-2.828l1.767 1.768a2 2 0 1 0 2.829-2.829l-6.364-6.364a2 2 0 1 0-2.829 2.829l1.768 1.767a2 2 0 0 0-2.828 2.829z"/><path d="m9.6 14.4 4.8-4.8"/></svg>
                                Workout Builder
                            </h1>
                            <p class="text-gray-400 mt-1">Create custom workout apps with edit, colors & sub-groups</p>
                        </header>

                        <!-- Tabs -->
                        <div class="flex gap-2 mb-6">
                            <button id="tab-structure" class="px-4 py-2 rounded-lg font-medium transition-colors ${state.activeTab === 'structure' ? 'tab-active' : 'tab-inactive'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"/><path d="M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"/><path d="M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"/></svg>
                                Structure
                            </button>
                            <button id="tab-colors" class="px-4 py-2 rounded-lg font-medium transition-colors ${state.activeTab === 'colors' ? 'tab-active' : 'tab-inactive'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="0.5" fill="currentColor"/><circle cx="17.5" cy="10.5" r="0.5" fill="currentColor"/><circle cx="8.5" cy="7.5" r="0.5" fill="currentColor"/><circle cx="6.5" cy="12.5" r="0.5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/></svg>
                                Colors
                            </button>
                        </div>

                        <!-- Tab Content -->
                        ${state.activeTab === 'structure' ? renderStructureTab() : renderColorsTab()}

                        <!-- Action Buttons -->
                        <div class="mt-6 flex flex-wrap gap-3">
                            
<button id="export-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V3"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="m7 10 5 5 5-5"/></svg>
                                Export HTML
                            </button>
<button id="copy-export-btn" class="ml-2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
    Copy Code
</button>

                            <button id="toggle-preview-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-colors lg:hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                Preview App
                            </button>
                        </div>
                    </div>

                    <!-- Right Panel: Live Preview -->
                    <div class="hidden lg:block w-full lg:w-1/2 p-4 lg:p-6 bg-gray-900 overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-white">Live Preview</h2>
                            <button id="fullscreen-preview-btn" class="text-gray-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
                            </button>
                        </div>
                        <div class="preview-frame bg-gray-950 rounded-xl overflow-hidden" style="min-height: 600px;">
                            ${renderPreviewContent()}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderStructureTab = () => {
            return `
                <div class="space-y-4">
                    <!-- App Settings -->
                    <div class="bg-gray-800 p-4 rounded-xl">
                        <h3 class="text-lg font-semibold text-white mb-3">App Settings</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-400 block mb-1">App Name</label>
                                <input type="text" id="app-name-input" value="${state.appSettings.appName}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 focus:outline-none" />
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 block mb-1">Description</label>
                                <input type="text" id="app-desc-input" value="${state.appSettings.appDescription}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 focus:outline-none" />
                            <div>
                                <label class="text-sm text-gray-400 block mb-1">Logo URL</label>
                                <input type="text" id="app-logo-input" value="${state.appSettings.appLogoUrl || ''}" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 focus:outline-none" />
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Groups -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-white">Groups</h3>
                            <button id="add-group-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Add Group
                            </button>
                        </div>
                        ${state.groups.map(group => renderGroupItem(group, 0)).join('')}
                    </div>
                </div>
            `;
        };

        const renderGroupItem = (group, depth) => {
            const indentClass = depth > 0 ? 'nested-group' : '';
            return `
                <div class="bg-gray-800 rounded-xl overflow-hidden ${indentClass}" data-group-id="${group.id}" data-depth="${depth}">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <button class="toggle-group-btn text-gray-400 hover:text-white transition-colors" data-group-id="${group.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-transform ${group.isExpanded ? 'rotate-90' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                </button>
                                <div class="p-2 bg-emerald-900 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"/><path d="M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"/><path d="M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"/></svg>
                                </div>
                                ${group.isEditing ? `
                                    <input type="text" class="edit-input flex-1" value="${group.name}" data-group-id="${group.id}" id="edit-group-input-${group.id}" />
                                    <button class="save-group-btn bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded text-sm" data-group-id="${group.id}">Save</button>
                                    <button class="cancel-group-btn bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-sm" data-group-id="${group.id}">Cancel</button>
                                ` : `
                                    <span class="text-lg font-semibold text-white">${group.name}</span>
                                    <span class="text-sm text-gray-400">(${group.workouts.length} workouts${group.subGroups.length > 0 ? `, ${group.subGroups.length} sub-groups` : ''})</span>
                                `}
                            </div>
                            <div class="flex items-center gap-2">
                                ${!group.isEditing ? `
                                    <button class="edit-group-btn text-gray-400 hover:text-indigo-400 transition-colors" data-group-id="${group.id}" title="Edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                    </button>
                                ` : ''}
                                <button class="delete-group-btn text-gray-400 hover:text-red-400 transition-colors" data-group-id="${group.id}" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapsible-content ${group.isExpanded ? 'open' : ''}" id="group-content-${group.id}">
                        <div class="p-4 space-y-3">
                            <!-- Add Sub-Group Button -->
                            ${depth < 2 ? `
                                <button class="add-subgroup-btn w-full border-2 border-dashed border-gray-600 hover:border-indigo-500 text-gray-400 hover:text-indigo-400 p-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors" data-parent-group-id="${group.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                    Add Sub-Group
                                </button>
                            ` : ''}

                            <!-- Sub-Groups -->
                            ${group.subGroups.map(sg => renderGroupItem(sg, depth + 1)).join('')}

                            <!-- Workouts in this group -->
                            ${group.workouts.map(workout => renderWorkoutItem(workout, group.id)).join('')}

                            <!-- Add Workout Button -->
                            <button class="add-workout-btn w-full border-2 border-dashed border-gray-600 hover:border-emerald-500 text-gray-400 hover:text-emerald-400 p-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors" data-group-id="${group.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Add Workout
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderWorkoutItem = (workout, groupId) => {
            return `
                <div class="bg-gray-700 rounded-lg overflow-hidden" data-workout-id="${workout.id}">
                    <div class="p-3 border-b border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 flex-1">
                                <button class="toggle-workout-btn text-gray-400 hover:text-white transition-colors" data-workout-id="${workout.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform ${workout.isExpanded ? 'rotate-90' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                </button>
                                <div class="p-1.5 bg-indigo-900 rounded">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-indigo-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.596 12.768a2 2 0 1 0 2.829-2.829l-1.768-1.767a2 2 0 0 0 2.828-2.829l-2.828-2.828a2 2 0 0 0-2.829 2.828l-1.767-1.768a2 2 0 1 0-2.829 2.829z"/><path d="m2.5 21.5 1.4-1.4"/><path d="m20.1 3.9 1.4-1.4"/><path d="M5.343 21.485a2 2 0 1 0 2.829-2.828l1.767 1.768a2 2 0 1 0 2.829-2.829l-6.364-6.364a2 2 0 1 0-2.829 2.829l1.768 1.767a2 2 0 0 0-2.828 2.829z"/><path d="m9.6 14.4 4.8-4.8"/></svg>
                                </div>
                                ${workout.isEditing ? `
                                    <div class="flex-1 space-y-2">
                                        <input type="text" class="edit-input w-full" value="${workout.name}" id="edit-workout-name-${workout.id}" placeholder="Workout name" />
                                        <input type="text" class="edit-input w-full text-sm" value="${workout.target}" id="edit-workout-target-${workout.id}" placeholder="Target muscles" />
                                    </div>
                                    <button class="save-workout-btn bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded text-sm" data-workout-id="${workout.id}" data-group-id="${groupId}">Save</button>
                                    <button class="cancel-workout-btn bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-sm" data-workout-id="${workout.id}">Cancel</button>
                                ` : `
                                    <div class="flex-1">
                                        <span class="font-medium text-white">${workout.name}</span>
                                        <p class="text-xs text-gray-400">${workout.target} - ${calculateWorkoutDuration(workout.exercises)}</p>
                                    </div>
                                `}
                            </div>
                            <div class="flex items-center gap-2">
                                ${!workout.isEditing ? `
                                    <button class="edit-workout-btn text-gray-400 hover:text-indigo-400 transition-colors" data-workout-id="${workout.id}" title="Edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                    </button>
                                ` : ''}
                                <button class="delete-workout-btn text-gray-400 hover:text-red-400 transition-colors" data-workout-id="${workout.id}" data-group-id="${groupId}" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapsible-content ${workout.isExpanded ? 'open' : ''}" id="workout-content-${workout.id}">
                        <div class="p-3 space-y-2 bg-gray-750">
                            ${workout.exercises.map((ex, idx) => renderExerciseItem(ex, workout.id, groupId, idx)).join('')}
                            
                            <!-- Add Exercise Button -->
                            <button class="add-exercise-btn w-full border border-dashed border-gray-500 hover:border-indigo-500 text-gray-400 hover:text-indigo-400 p-2 rounded text-xs font-medium flex items-center justify-center gap-1 transition-colors" data-workout-id="${workout.id}" data-group-id="${groupId}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Add Exercise
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderExerciseItem = (exercise, workoutId, groupId, index) => {
            const isExercise = exercise.type === 'exercise';
            const bgClass = isExercise ? 'bg-emerald-900/30 border-emerald-700' : 'bg-rose-900/30 border-rose-700';
            
            return `
                <div class="p-2 rounded border ${bgClass}" data-exercise-id="${exercise.id}">
                    <div class="flex items-center gap-2">
                        <span class="w-5 h-5 rounded-full ${isExercise ? 'bg-emerald-500' : 'bg-rose-500'} text-white text-xs font-bold flex items-center justify-center">${index + 1}</span>
                        
                        ${exercise.isEditing ? `
                            <input type="text" class="edit-input flex-1 text-sm" value="${exercise.name}" id="edit-ex-name-${exercise.id}" placeholder="Exercise name" />
                            <select id="edit-ex-type-${exercise.id}" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white">
                                <option value="exercise" ${exercise.type === 'exercise' ? 'selected' : ''}>Exercise</option>
                                <option value="rest" ${exercise.type === 'rest' ? 'selected' : ''}>Rest</option>
                            </select>
                            <input type="number" class="edit-input w-16 text-sm" value="${exercise.duration}" id="edit-ex-duration-${exercise.id}" min="5" />
                            <span class="text-gray-400 text-xs">sec</span>
                        </div>
                        <div class="flex items-center gap-2 mt-2 ml-7">
                            <input type="text" class="edit-input flex-1 text-xs" value="${exercise.videoUrl || ''}" id="edit-ex-video-${exercise.id}" placeholder="Video URL (optional)" />
                            <input type="text" class="edit-input flex-1 text-xs" value="${exercise.imageUrl || ''}" id="edit-ex-image-${exercise.id}" placeholder="Image URL (optional)" />
                            <button class="save-exercise-btn bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-0.5 rounded text-xs" data-exercise-id="${exercise.id}" data-workout-id="${workoutId}" data-group-id="${groupId}">Save</button>
                            <button class="cancel-exercise-btn bg-gray-600 hover:bg-gray-700 text-white px-2 py-0.5 rounded text-xs" data-exercise-id="${exercise.id}" data-workout-id="${workoutId}">Cancel</button>
                        </div>
                    ` : `
                        <span class="flex-1 text-sm text-white">${exercise.name}</span>
                        <span class="text-xs ${isExercise ? 'text-emerald-400' : 'text-rose-400'}">${exercise.type}</span>
                        <span class="text-sm font-medium text-gray-300">${exercise.duration}s</span>
                        ${exercise.videoUrl ? '<span class="text-xs text-indigo-400">Video</span>' : ''}
                        ${exercise.imageUrl ? '<span class="text-xs text-blue-400">Image</span>' : ''}
                        <button class="edit-exercise-btn text-gray-400 hover:text-indigo-400 transition-colors" data-exercise-id="${exercise.id}" data-workout-id="${workoutId}" title="Edit">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button class="delete-exercise-btn text-gray-400 hover:text-red-400 transition-colors" data-exercise-id="${exercise.id}" data-workout-id="${workoutId}" data-group-id="${groupId}" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>
                    `}
                </div>
            `;
        };

        const renderColorsTab = () => {
            return `
                <div class="space-y-4">
                    <div class="bg-gray-800 p-4 rounded-xl">
                        <h3 class="text-lg font-semibold text-white mb-4">App Color Customization</h3>
                        <p class="text-sm text-gray-400 mb-4">Customize the colors for your generated workout app</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-sm text-gray-300 block">Background</label>
                                <div class="flex items-center gap-2">
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="color-background" value="${state.colors.background}" />
                                    </div>
                                    <input type="text" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-24" value="${state.colors.background}" id="color-background-text" />
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm text-gray-300 block">Card Background</label>
                                <div class="flex items-center gap-2">
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="color-card" value="${state.colors.cardBackground}" />
                                    </div>
                                    <input type="text" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-24" value="${state.colors.cardBackground}" id="color-card-text" />
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm text-gray-300 block">Primary Color</label>
                                <div class="flex items-center gap-2">
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="color-primary" value="${state.colors.primaryColor}" />
                                    </div>
                                    <input type="text" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-24" value="${state.colors.primaryColor}" id="color-primary-text" />
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm text-gray-300 block">Secondary Color</label>
                                <div class="flex items-center gap-2">
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="color-secondary" value="${state.colors.secondaryColor}" />
                                    </div>
                                    <input type="text" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-24" value="${state.colors.secondaryColor}" id="color-secondary-text" />
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm text-gray-300 block">Text Color</label>
                                <div class="flex items-center gap-2">
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="color-text" value="${state.colors.textColor}" />
                                    </div>
                                    <input type="text" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-24" value="${state.colors.textColor}" id="color-text-text" />
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-sm text-gray-300 block">Accent Color</label>
                                <div class="flex items-center gap-2">
                                    <div class="color-picker-wrapper">
                                        <input type="color" id="color-accent" value="${state.colors.accentColor}" />
                                    </div>
                                    <input type="text" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white w-24" value="${state.colors.accentColor}" id="color-accent-text" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <button id="reset-colors-btn" class="text-sm text-gray-400 hover:text-white transition-colors">
                                Reset to Default Colors
                            </button>
                        </div>
                    </div>
                    
                    <!-- Color Preview Card -->
                    <div class="rounded-xl p-4 border border-gray-700" style="background: ${state.colors.cardBackground}">
                        <h4 class="font-semibold mb-2" style="color: ${state.colors.textColor}">Color Preview</h4>
                        <p class="text-sm mb-3" style="color: ${state.colors.textColor}; opacity: 0.7;">This is how your app will look with these colors.</p>
                        <div class="flex gap-2">
                            <button class="px-3 py-1.5 rounded-lg text-sm font-medium text-white" style="background: ${state.colors.primaryColor}">Primary</button>
                            <button class="px-3 py-1.5 rounded-lg text-sm font-medium text-white" style="background: ${state.colors.secondaryColor}">Secondary</button>
                            <button class="px-3 py-1.5 rounded-lg text-sm font-medium text-white" style="background: ${state.colors.accentColor}">Accent</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderPreviewContent = () => {
            const workouts = getAllWorkouts();
            const groups = state.groups.map(g => ({
                name: g.name,
                count: g.workouts.length + g.subGroups.reduce((sum, sg) => sum + sg.workouts.length, 0)
            }));

            return `
                <div class="p-4" style="background: ${state.colors.background}; color: ${state.colors.textColor}; min-height: 100%;">
                    <header class="py-4 mb-4 text-center flex flex-col items-center gap-3">
                        ${state.appSettings.appLogoUrl ? `<img src="${state.appSettings.appLogoUrl}" class="h-16 object-contain" />` : ``}
                        <h1 class="text-2xl font-extrabold" style="color: ${state.colors.textColor}">${state.appSettings.appName}</h1>
                        <p class="text-sm opacity-70">${state.appSettings.appDescription}</p>
                    </header>
                    
                    <div class="space-y-3">
                        ${groups.map(group => `
                            <div class="p-4 rounded-xl" style="background: ${state.colors.cardBackground}; border-bottom: 3px solid ${state.colors.secondaryColor};">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 rounded-lg" style="background: ${state.colors.secondaryColor}20;">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" style="color: ${state.colors.secondaryColor}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"/><path d="M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"/><path d="M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"/></svg>
                                        </div>
                                        <div>
                                            <h2 class="font-bold">${group.name}</h2>
                                            <p class="text-xs opacity-60">${group.count} Workouts</p>
                                        </div>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${groups.length === 0 ? `
                        <div class="text-center py-8 opacity-50">
                            <p>No groups yet. Add a group to get started!</p>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        const renderFullPreview = () => {
            return `
                <div class="min-h-screen">
                    <div class="p-4 bg-gray-800 flex items-center justify-between">
                        <button id="back-to-builder-btn" class="flex items-center text-indigo-400 hover:text-indigo-300 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            Back to Builder
                        </button>
                        <h2 class="text-lg font-bold text-white">Full Preview</h2>
                        <div></div>
                    </div>
                    ${renderPreviewContent()}
                </div>
            `;
        };

        // ==================== EVENT HANDLING ====================
        const findGroupById = (groups, id) => {
            for (const group of groups) {
                if (group.id === id) return { group, parent: null };
                const result = findGroupById(group.subGroups, id);
                if (result.group) return { group: result.group, parent: group };
            }
            return { group: null, parent: null };
        };

        const findWorkoutById = (groups, workoutId) => {
            for (const group of groups) {
                const workout = group.workouts.find(w => w.id === workoutId);
                if (workout) return { workout, group };
                const result = findWorkoutById(group.subGroups, workoutId);
                if (result.workout) return result;
            }
            return { workout: null, group: null };
        };

        const attachEventListeners = () => {
            // Tab switching
            document.getElementById('tab-structure')?.addEventListener('click', () => {
                state.activeTab = 'structure';
                render();
            });
            document.getElementById('tab-colors')?.addEventListener('click', () => {
                state.activeTab = 'colors';
                render();
            });

            // App settings
            document.getElementById('app-name-input')?.addEventListener('input', (e) => {
                state.appSettings.appName = e.target.value;
                updatePreview();
            });
            document.getElementById('app-desc-input')?.addEventListener('input', (e) => {
                state.appSettings.appDescription = e.target.value;
                updatePreview();
            });

            // Add Group
            document.getElementById('add-group-btn')?.addEventListener('click', () => {
                state.groups.push({
                    id: generateId(),
                    name: 'New Group',
                    isEditing: true,
                    isExpanded: true,
                    subGroups: [],
                    workouts: []
                });
                render();
            });

            // Toggle group expand/collapse
            document.querySelectorAll('.toggle-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.groupId);
                    if (group) {
                        group.isExpanded = !group.isExpanded;
                        render();
                    }
                });
            });

            // Edit group
            document.querySelectorAll('.edit-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.groupId);
                    if (group) {
                        group.isEditing = true;
                        render();
                    }
                });
            });

            // Save group
            document.querySelectorAll('.save-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.groupId);
                    if (group) {
                        const input = document.getElementById(`edit-group-input-${group.id}`);
                        if (input) group.name = input.value;
                        group.isEditing = false;
                        render();
                    }
                });
            });

            // Cancel group edit
            document.querySelectorAll('.cancel-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.groupId);
                    if (group) {
                        group.isEditing = false;
                        render();
                    }
                });
            });

            // Delete group
            document.querySelectorAll('.delete-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const groupId = btn.dataset.groupId;
                    const deleteFromGroups = (groups) => {
                        const idx = groups.findIndex(g => g.id === groupId);
                        if (idx !== -1) {
                            groups.splice(idx, 1);
                            return true;
                        }
                        for (const group of groups) {
                            if (deleteFromGroups(group.subGroups)) return true;
                        }
                        return false;
                    };
                    deleteFromGroups(state.groups);
                    render();
                });
            });

            // Add sub-group
            document.querySelectorAll('.add-subgroup-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.parentGroupId);
                    if (group) {
                        group.subGroups.push({
                            id: generateId(),
                            name: 'New Sub-Group',
                            isEditing: true,
                            isExpanded: true,
                            subGroups: [],
                            workouts: []
                        });
                        render();
                    }
                });
            });

            // Add workout
            document.querySelectorAll('.add-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.groupId);
                    if (group) {
                        group.workouts.push({
                            id: generateId(),
                            name: 'New Workout',
                            target: 'Target muscles',
                            duration: '0 min',
                            icon: 'Dumbbell',
                            isEditing: true,
                            isExpanded: true,
                            exercises: []
                        });
                        render();
                    }
                });
            });

            // Toggle workout
            document.querySelectorAll('.toggle-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        workout.isExpanded = !workout.isExpanded;
                        render();
                    }
                });
            });

            // Edit workout
            document.querySelectorAll('.edit-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        workout.isEditing = true;
                        render();
                    }
                });
            });

            // Save workout
            document.querySelectorAll('.save-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        const nameInput = document.getElementById(`edit-workout-name-${workout.id}`);
                        const targetInput = document.getElementById(`edit-workout-target-${workout.id}`);
                        if (nameInput) workout.name = nameInput.value;
                        if (targetInput) workout.target = targetInput.value;
                        workout.isEditing = false;
                        render();
                    }
                });
            });

            // Cancel workout edit
            document.querySelectorAll('.cancel-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        workout.isEditing = false;
                        render();
                    }
                });
            });

            // Delete workout
            document.querySelectorAll('.delete-workout-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { group } = findGroupById(state.groups, btn.dataset.groupId);
                    if (group) {
                        group.workouts = group.workouts.filter(w => w.id !== btn.dataset.workoutId);
                        render();
                    }
                });
            });

            // Add exercise
            document.querySelectorAll('.add-exercise-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        workout.exercises.push({
                            id: generateId(),
                            name: 'New Exercise',
                            type: 'exercise',
                            duration: 30,
                            isEditing: true,
                            videoUrl: '',
                            imageUrl: ''
                        });
                        render();
                    }
                });
            });

            // Edit exercise
            document.querySelectorAll('.edit-exercise-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        const exercise = workout.exercises.find(e => e.id === btn.dataset.exerciseId);
                        if (exercise) {
                            exercise.isEditing = true;
                            render();
                        }
                    }
                });
            });

            // Save exercise
            document.querySelectorAll('.save-exercise-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        const exercise = workout.exercises.find(e => e.id === btn.dataset.exerciseId);
                        if (exercise) {
                            const nameInput = document.getElementById(`edit-ex-name-${exercise.id}`);
                            const typeSelect = document.getElementById(`edit-ex-type-${exercise.id}`);
                            const durationInput = document.getElementById(`edit-ex-duration-${exercise.id}`);
                            const videoInput = document.getElementById(`edit-ex-video-${exercise.id}`);
                            const imageInput = document.getElementById(`edit-ex-image-${exercise.id}`);
                            if (nameInput) exercise.name = nameInput.value;
                            if (typeSelect) exercise.type = typeSelect.value;
                            if (durationInput) exercise.duration = parseInt(durationInput.value) || 30;
                            if (videoInput) exercise.videoUrl = videoInput.value;
                            if (imageInput) exercise.imageUrl = imageInput.value;
                            exercise.isEditing = false;
                            render();
                        }
                    }
                });
            });

            // Cancel exercise edit
            document.querySelectorAll('.cancel-exercise-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        const exercise = workout.exercises.find(e => e.id === btn.dataset.exerciseId);
                        if (exercise) {
                            exercise.isEditing = false;
                            render();
                        }
                    }
                });
            });

            // Delete exercise
            document.querySelectorAll('.delete-exercise-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const { workout } = findWorkoutById(state.groups, btn.dataset.workoutId);
                    if (workout) {
                        workout.exercises = workout.exercises.filter(e => e.id !== btn.dataset.exerciseId);
                        render();
                    }
                });
            });

            // Color pickers
            ['background', 'card', 'primary', 'secondary', 'text', 'accent'].forEach(colorKey => {
                const picker = document.getElementById(`color-${colorKey}`);
                const textInput = document.getElementById(`color-${colorKey}-text`);
                
                if (picker) {
                    picker.addEventListener('input', (e) => {
                        const stateKey = colorKey === 'card' ? 'cardBackground' : 
                                        colorKey === 'primary' ? 'primaryColor' :
                                        colorKey === 'secondary' ? 'secondaryColor' :
                                        colorKey === 'text' ? 'textColor' :
                                        colorKey === 'accent' ? 'accentColor' : 'background';
                        state.colors[stateKey] = e.target.value;
                        if (textInput) textInput.value = e.target.value;
                        updatePreview();
                    });
                }
                
                if (textInput) {
                    textInput.addEventListener('input', (e) => {
                        const stateKey = colorKey === 'card' ? 'cardBackground' : 
                                        colorKey === 'primary' ? 'primaryColor' :
                                        colorKey === 'secondary' ? 'secondaryColor' :
                                        colorKey === 'text' ? 'textColor' :
                                        colorKey === 'accent' ? 'accentColor' : 'background';
                        state.colors[stateKey] = e.target.value;
                        if (picker) picker.value = e.target.value;
                        updatePreview();
                    });
                }
            });

            document.getElementById('app-logo-input')?.addEventListener('input', (e) => {
                state.appSettings.appLogoUrl = e.target.value;
                updatePreview();
            });

            // Reset colors
            document.getElementById('reset-colors-btn')?.addEventListener('click', () => {
                state.colors = {
                    background: '#030712',
                    cardBackground: '#1f2937',
                    primaryColor: '#4f46e5',
                    secondaryColor: '#10b981',
                    textColor: '#f3f4f6',
                    accentColor: '#f59e0b'
                };
                render();
            });

            // Preview toggle (mobile)
            document.getElementById('toggle-preview-btn')?.addEventListener('click', () => {
                state.view = 'preview';
                render();
            });

            // Back to builder
            document.getElementById('back-to-builder-btn')?.addEventListener('click', () => {
                state.view = 'builder';
                render();
            });

            // Fullscreen preview
            document.getElementById('fullscreen-preview-btn')?.addEventListener('click', () => {
                state.view = 'preview';
                render();
            });

            // Export HTML
            document.getElementById('export-btn')?.addEventListener('click', exportHTML);
        };

        const updatePreview = () => {
            const previewContainer = document.querySelector('.preview-frame');
            if (previewContainer) {
                previewContainer.innerHTML = renderPreviewContent();
            }
        };

        // ==================== EXPORT FUNCTIONALITY ====================
        const exportHTML = () => {
            const workouts = [];
            const processGroup = (group, groupName) => {
                group.workouts.forEach(w => {
                    workouts.push({
                        id: w.id,
                        name: w.name,
                        group: groupName,
                        target: w.target,
                        duration: calculateWorkoutDuration(w.exercises),
                        icon: w.icon,
                        exercises: w.exercises.map(e => ({
                            name: e.name,
                            type: e.type,
                            duration: e.duration,
                            videoUrl: e.videoUrl || '',
                            imageUrl: e.imageUrl || ''
                        }))
                    });
                });
                group.subGroups.forEach(sg => processGroup(sg, `${groupName} > ${sg.name}`));
            };
            state.groups.forEach(g => processGroup(g, g.name));

            const html = generateExportedHTML(workouts);
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.appSettings.appName.replace(/\s+/g, '-').toLowerCase()}-workout-app.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const generateExportedHTML = (workouts) => {
            const groups = [...new Set(workouts.map(w => w.group.split(' > ')[0]))];
            const groupsData = groups.map(g => ({
                name: g,
                count: workouts.filter(w => w.group.split(' > ')[0] === g).length
            }));

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${state.appSettings.appName}</title>
    <meta name="description" content="${state.appSettings.appDescription}">
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        :root {
            --bg-color: ${state.colors.background};
            --card-bg: ${state.colors.cardBackground};
            --primary: ${state.colors.primaryColor};
            --secondary: ${state.colors.secondaryColor};
            --text-color: ${state.colors.textColor};
            --accent: ${state.colors.accentColor};
        }
        body { background: var(--bg-color); color: var(--text-color); }
        .card-bg { background: var(--card-bg); }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        .border-primary { border-color: var(--primary); }
        .border-secondary { border-color: var(--secondary); }
        .text-accent { color: var(--accent); }
        .big-timer { font-size: 4rem; line-height: 1; }
        .big-timer.seconds-only { font-size: 5rem; }
        .progress-circle { transition: stroke-dashoffset 0.3s ease; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app"></div>
    <script>
        const WORKOUTS = ${JSON.stringify(workouts, null, 2)};
        const APP_NAME = "${state.appSettings.appName}";
        const APP_LOGO_URL = "${state.appSettings.appLogoUrl}";
        const APP_DESC = "${state.appSettings.appDescription}";
        const COLORS = ${JSON.stringify(state.colors)};
        
        let currentView = 'groupList';
        let selectedGroupName = null;
        let selectedWorkoutId = null;
        let selectedRounds = 1;
        let currentStepIndex = 0;
        let currentWorkoutSteps = [];
        let timeLeft = 0;
        let initialTime = 0;
        let totalTimeLeft = 0;
        let isRunning = false;
        let timerInterval = null;
        let introInterval = null;
        let preWorkoutCountdown = 5;
        let audioContext = null;

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        };

        const formatBigTimer = (seconds) => {
            if (seconds < 60) return seconds.toString();
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        };

        const playTone = (frequency = 440, duration = 0.1) => {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        };

        const navigateTo = (view, params = {}) => {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            if (introInterval) { clearInterval(introInterval); introInterval = null; }
            isRunning = false;
            preWorkoutCountdown = 5;

            currentView = view;
            if (params.groupName !== undefined) selectedGroupName = params.groupName;
            if (params.workoutId !== undefined) {
                selectedWorkoutId = params.workoutId;
                const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
                if (workout) {
                    currentWorkoutSteps = [];
                    for (let round = 1; round <= selectedRounds; round++) {
                        workout.exercises.forEach(ex => {
                            currentWorkoutSteps.push({ ...ex, round });
                        });
                        if (round < selectedRounds) {
                            currentWorkoutSteps.push({ name: 'Round Break', type: 'transition', duration: 60, round });
                        }
                    }
                    currentStepIndex = 0;
                    if (currentWorkoutSteps.length > 0) {
                        timeLeft = currentWorkoutSteps[0].duration;
                        initialTime = currentWorkoutSteps[0].duration;
                        totalTimeLeft = currentWorkoutSteps.reduce((sum, step) => sum + step.duration, 0);
                    }
                }
            }
            renderApp();
        };

        const renderApp = () => {
            const app = document.getElementById('app');
            switch (currentView) {
                case 'groupList': renderGroupList(app); break;
                case 'workoutList': renderGroupWorkouts(app); break;
                case 'detail': renderWorkoutDetail(app); break;
                case 'player': renderWorkoutPlayer(app); break;
                default: renderGroupList(app);
            }
        };

        const renderGroupList = (container) => {
            const groups = [...new Set(WORKOUTS.map(w => w.group.split(' > ')[0]))].map(g => ({
                name: g,
                count: WORKOUTS.filter(w => w.group.split(' > ')[0] === g).length
            }));

            container.innerHTML = \`
                <div class="min-h-screen p-4" style="background: \${COLORS.background}; color: \${COLORS.textColor};">
                    <header class="py-6 mb-6 text-center">
                        <h1 class="text-3xl font-extrabold">\${APP_NAME}</h1>
                        <p class="opacity-70 mt-1">\${APP_DESC}</p>
                    </header>
                    <div class="space-y-4" id="group-list-container"></div>
                </div>
            \`;

            const listContainer = document.getElementById('group-list-container');
            groups.forEach(group => {
                const button = document.createElement('button');
                button.className = "w-full text-left p-6 rounded-2xl shadow-lg transition-all duration-300";
                button.style.background = COLORS.cardBackground;
                button.style.borderBottom = '4px solid ' + COLORS.secondaryColor;
                button.innerHTML = \`
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-3 rounded-lg mr-4" style="background: \${COLORS.secondaryColor}20;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" style="color: \${COLORS.secondaryColor}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z"/><path d="M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12"/><path d="M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17"/></svg>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">\${group.name}</h2>
                                <p class="text-sm opacity-60 mt-1">\${group.count} Workouts</p>
                            </div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                    </div>
                \`;
                button.addEventListener('click', () => navigateTo('workoutList', { groupName: group.name }));
                listContainer.appendChild(button);
            });
        };

        const renderGroupWorkouts = (container) => {
            const filteredWorkouts = WORKOUTS.filter(w => w.group.split(' > ')[0] === selectedGroupName);
            
            container.innerHTML = \`
                <div class="min-h-screen p-4" style="background: \${COLORS.background}; color: \${COLORS.textColor};">
                    <header class="py-6 mb-6">
                        <button id="back-to-groups" class="flex items-center font-medium mb-6" style="color: \${COLORS.primaryColor}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg> All Groups
                        </button>
                        <h1 class="text-3xl font-extrabold">\${selectedGroupName}</h1>
                        <p class="opacity-70 mt-1">Select a routine from this collection.</p>
                    </header>
                    <div class="space-y-4" id="workout-list-container"></div>
                </div>
            \`;

            document.getElementById('back-to-groups').addEventListener('click', () => navigateTo('groupList'));

            const listContainer = document.getElementById('workout-list-container');
            filteredWorkouts.forEach(workout => {
                const button = document.createElement('button');
                button.className = "w-full text-left p-5 rounded-2xl shadow-lg transition-all duration-300";
                button.style.background = COLORS.cardBackground;
                button.style.borderBottom = '4px solid ' + COLORS.primaryColor;
                button.innerHTML = \`
                    <div class="flex items-start">
                        <div class="p-3 rounded-lg mr-4" style="background: \${COLORS.primaryColor}20;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" style="color: \${COLORS.primaryColor}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.596 12.768a2 2 0 1 0 2.829-2.829l-1.768-1.767a2 2 0 0 0 2.828-2.829l-2.828-2.828a2 2 0 0 0-2.829 2.828l-1.767-1.768a2 2 0 1 0-2.829 2.829z"/><path d="m2.5 21.5 1.4-1.4"/><path d="m20.1 3.9 1.4-1.4"/><path d="M5.343 21.485a2 2 0 1 0 2.829-2.828l1.767 1.768a2 2 0 1 0 2.829-2.829l-6.364-6.364a2 2 0 1 0-2.829 2.829l1.768 1.767a2 2 0 0 0-2.828 2.829z"/><path d="m9.6 14.4 4.8-4.8"/></svg>
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-xl font-bold">\${workout.name}</h2>
                            <p class="text-sm opacity-70 mt-1">\${workout.target}</p>
                            <p class="text-sm font-semibold flex items-center mt-2" style="color: \${COLORS.primaryColor}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> \${workout.duration}
                            </p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                    </div>
                \`;
                button.addEventListener('click', () => navigateTo('detail', { workoutId: workout.id }));
                listContainer.appendChild(button);
            });
        };

        const renderWorkoutDetail = (container) => {
            const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
            if (!workout) return navigateTo('groupList');

            const oneRoundTime = workout.exercises.reduce((sum, step) => sum + step.duration, 0);
            const getEstimatedTime = (rounds) => {
                const totalExerciseTime = oneRoundTime * rounds;
                const totalTransitionRest = (rounds > 1 ? rounds - 1 : 0) * 60;
                return formatTime(totalExerciseTime + totalTransitionRest);
            };

            container.innerHTML = \`
                <div class="min-h-screen flex flex-col p-4" style="background: \${COLORS.background}; color: \${COLORS.textColor};">
                    <button id="back-to-workouts" class="flex items-center font-medium mb-6" style="color: \${COLORS.primaryColor}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg> Back to Workouts
                    </button>

                    <div class="p-6 rounded-2xl shadow-xl mb-6" style="background: \${COLORS.cardBackground}; border-top: 4px solid \${COLORS.primaryColor};">
                        <div class="flex items-center justify-between mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" style="color: \${COLORS.primaryColor}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.596 12.768a2 2 0 1 0 2.829-2.829l-1.768-1.767a2 2 0 0 0 2.828-2.829l-2.828-2.828a2 2 0 0 0-2.829 2.828l-1.767-1.768a2 2 0 1 0-2.829 2.829z"/><path d="m2.5 21.5 1.4-1.4"/><path d="m20.1 3.9 1.4-1.4"/><path d="M5.343 21.485a2 2 0 1 0 2.829-2.828l1.767 1.768a2 2 0 1 0 2.829-2.829l-6.364-6.364a2 2 0 1 0-2.829 2.829l1.768 1.767a2 2 0 0 0-2.828 2.829z"/><path d="m9.6 14.4 4.8-4.8"/></svg>
                            <p class="text-sm font-semibold opacity-60 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> \${getEstimatedTime(selectedRounds)} Total
                            </p>
                        </div>
                        <h1 class="text-3xl font-extrabold mb-1">\${workout.name}</h1>
                        <p class="opacity-70 italic">Target: \${workout.target}</p>
                        
                        <div class="mt-4 pt-4 border-t border-gray-700 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <label for="rounds-selector" class="text-sm font-semibold opacity-60 mb-2 sm:mb-0">Select Rounds:</label>
                            <select id="rounds-selector" class="p-2 rounded-lg focus:outline-none cursor-pointer" style="background: \${COLORS.cardBackground}; border: 1px solid \${COLORS.primaryColor};">
                                <option value="1">1 Round (\${getEstimatedTime(1)})</option>
                                <option value="2">2 Rounds (\${getEstimatedTime(2)})</option>
                                <option value="3">3 Rounds (\${getEstimatedTime(3)})</option>
                                <option value="4">4 Rounds (\${getEstimatedTime(4)})</option>
                                <option value="5">5 Rounds (\${getEstimatedTime(5)})</option>
                            </select>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold mb-3 border-b border-gray-700 pb-2">Exercises (Per Round)</h2>
                    <div class="space-y-3 flex-grow overflow-y-auto pb-20" id="exercise-list"></div>

                    <div class="fixed bottom-0 left-0 right-0 p-4 shadow-2xl" style="background: \${COLORS.background}; border-top: 1px solid \${COLORS.cardBackground};">
                        <button id="start-workout-btn" class="w-full text-white p-4 rounded-xl text-xl font-bold flex items-center justify-center" style="background: \${COLORS.primaryColor};">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start Workout
                        </button>
                    </div>
                </div>
            \`;

            document.getElementById('back-to-workouts').addEventListener('click', () => navigateTo('workoutList', { groupName: workout.group.split(' > ')[0] }));
            
            const roundsSelector = document.getElementById('rounds-selector');
            roundsSelector.value = selectedRounds;
            roundsSelector.addEventListener('change', (e) => { selectedRounds = parseInt(e.target.value, 10); });

            document.getElementById('start-workout-btn').addEventListener('click', () => {
                selectedRounds = parseInt(document.getElementById('rounds-selector').value, 10);
                navigateTo('player', { workoutId: selectedWorkoutId });
            });

            const exerciseList = document.getElementById('exercise-list');
            workout.exercises.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                const isExercise = step.type === 'exercise';
                stepDiv.className = 'flex justify-between items-center p-4 rounded-xl shadow-md transition-shadow';
                stepDiv.style.background = isExercise ? COLORS.secondaryColor + '20' : COLORS.accentColor + '20';
                stepDiv.innerHTML = \`
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full text-white text-xs font-bold flex items-center justify-center mr-3" style="background: \${isExercise ? COLORS.secondaryColor : COLORS.accentColor};">\${index + 1}</span>
                        <div>
                            <p class="text-lg font-semibold">\${step.name}</p>
                            <p class="text-xs opacity-60">\${isExercise ? 'Active' : 'Rest'}</p>
                        </div>
                    </div>
                    <p class="font-bold">\${step.duration}s</p>
                \`;
                exerciseList.appendChild(stepDiv);
            });
        };

        const renderWorkoutPlayer = (container) => {
            const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
            if (!workout || currentWorkoutSteps.length === 0) return navigateTo('groupList');

            if (preWorkoutCountdown > 0) {
                container.innerHTML = \`
                    <div class="min-h-screen flex flex-col items-center justify-center p-4 text-center" style="background: \${COLORS.background}; color: \${COLORS.textColor};">
                        <h1 class="text-3xl font-semibold mb-8" style="color: \${COLORS.primaryColor}">Get Ready for:</h1>
                        <h2 class="text-6xl font-extrabold mb-12 animate-pulse">\${currentWorkoutSteps[0].name}</h2>
                        <div id="countdown-timer" class="text-9xl font-black" style="color: \${COLORS.secondaryColor}">\${preWorkoutCountdown}</div>
                        <button id="skip-countdown-btn" class="mt-16 text-lg underline opacity-60">Skip Countdown</button>
                    </div>
                \`;
                document.getElementById('skip-countdown-btn').addEventListener('click', () => {
                    if (introInterval) clearInterval(introInterval);
                    introInterval = null;
                    preWorkoutCountdown = 0;
                    isRunning = true;
                    renderApp();
                });
                
                introInterval = setInterval(() => {
                    preWorkoutCountdown--;
                    const timerEl = document.getElementById('countdown-timer');
                    if (preWorkoutCountdown >= 1 && preWorkoutCountdown <= 3) playTone(440);
                    if (preWorkoutCountdown <= 0) {
                        playTone(880, 0.2);
                        clearInterval(introInterval);
                        isRunning = true;
                        renderApp();
                    } else {
                        if(timerEl) timerEl.textContent = preWorkoutCountdown;
                    }
                }, 1000);
                return;
            }

            const renderPlayerUI = () => {
                const currentStep = currentWorkoutSteps[currentStepIndex];
                const isLastStep = currentStepIndex === currentWorkoutSteps.length - 1;
                const nextStep = !isLastStep ? currentWorkoutSteps[currentStepIndex + 1] : null;
                const totalSteps = currentWorkoutSteps.length;

                let typeColor = COLORS.cardBackground;
                if (currentStep.type === 'exercise') typeColor = COLORS.secondaryColor;
                else if (currentStep.type === 'rest') typeColor = COLORS.accentColor;
                else if (currentStep.type === 'transition') typeColor = COLORS.primaryColor;

                const timerProgress = initialTime > 0 ? (timeLeft / initialTime) * 100 : 0;
                const circumference = 2 * Math.PI * 45;
                const dashoffset = circumference * (1 - timerProgress / 100);

                const nextUpHtml = nextStep ? \`
                    <div class="mt-4 p-3 rounded-xl shadow-inner text-center" style="background: \${COLORS.cardBackground}; border: 1px solid \${COLORS.cardBackground};">
                        <p class="text-xs font-semibold uppercase tracking-wider" style="color: \${COLORS.primaryColor}">Up Next</p>
                        <p class="text-xl font-bold mt-1">\${nextStep.name} (\${nextStep.duration}s)</p>
                    </div>
                \` : '';
                
                const currentRoundDisplay = currentStep.round ? 
                    (currentStep.type === 'transition' ? 'Break After Round ' + currentStep.round : 'Round ' + currentStep.round + ' of ' + selectedRounds)
                    : 'Warmup';

                const DEMO_VIDEO_URL = 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4';
                const videoSourceUrl = currentStep.videoUrl || currentStep.imageUrl || DEMO_VIDEO_URL;
                const isImage = currentStep.imageUrl && !currentStep.videoUrl;
                const mediaHtml = isImage 
                    ? '<img src="' + videoSourceUrl + '" alt="' + currentStep.name + '" class="absolute inset-0 w-full h-full object-cover" />'
                    : '<video id="demo-video" class="absolute inset-0 w-full h-full object-cover" src="' + videoSourceUrl + '" autoplay loop muted playsinline></video>';

                const playerHtml = \`
                    <div class="min-h-screen flex flex-col p-4" style="background: \${COLORS.background}; color: \${COLORS.textColor};">
                        <div class="flex items-center justify-between mb-6">
                            <button id="player-back-btn" class="flex items-center font-medium" style="color: \${COLORS.primaryColor}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg> Back
                            </button>
                            <h1 class="text-xl font-bold truncate">\${workout.name} (\${selectedRounds} Rds)</h1>
                            <div class="text-right">
                                <p class="text-xs opacity-60 uppercase tracking-wider">Total Time Left</p>
                                <p id="total-time-display" class="text-lg font-bold">\${formatTime(totalTimeLeft)}</p>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col lg:grid lg:grid-cols-2 lg:gap-8">
                            <div class="flex flex-col">
                                <div class="w-full aspect-video rounded-xl shadow-lg relative overflow-hidden" style="background: \${COLORS.cardBackground};">
                                    \${mediaHtml}
                                </div>
                                <div id="current-step-card" class="mt-6 lg:mt-4 p-4 rounded-xl shadow-lg text-white text-center transition-colors duration-300" style="background: \${typeColor};">
                                    <div class="text-sm font-light uppercase tracking-widest opacity-80">\${currentStep.type === 'exercise' ? 'CURRENT EXERCISE' : 'BREAK TIME'}</div>
                                    <h2 class="text-4xl font-extrabold mt-1 mb-2">\${currentStep.name}</h2>
                                    <p class="text-xs font-semibold opacity-70">\${currentRoundDisplay}</p>
                                </div>
                                \${nextUpHtml}
                            </div>
                            
                            <div class="flex flex-col justify-between pt-6 lg:pt-0">
                                <div class="lg:order-1">
                                    <div class="text-sm opacity-60 flex justify-between">
                                        <span id="step-count">Step \${currentStepIndex + 1} of \${totalSteps}</span>
                                        <span id="step-type" class="font-medium uppercase">\${currentStep.type}</span>
                                    </div>
                                    <div class="w-full h-2 rounded-full mt-1" style="background: \${COLORS.cardBackground};">
                                        <div id="overall-progress" class="h-2 rounded-full transition-all duration-700" style="width: \${((currentStepIndex + 1) / totalSteps) * 100}%; background: \${typeColor};"></div>
                                    </div>
                                </div>

                                <div class="relative flex justify-center my-10 lg:my-0 lg:flex-1 lg:items-center lg:justify-center lg:py-8">
                                    <div class="w-56 h-56 rounded-full flex items-center justify-center relative shadow-2xl">
                                        <div class="absolute inset-0 rounded-full" style="background: \${COLORS.cardBackground};"></div>
                                        <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" fill="none" stroke-width="5" stroke-dasharray="\${circumference}" stroke-dashoffset="\${dashoffset}" id="timer-progress-circle" class="progress-circle" style="stroke: \${typeColor};" transform="rotate(-90 50 50)"/>
                                        </svg>
                                        <p id="timer-display" class="relative big-timer font-black \${timeLeft < 60 ? 'seconds-only' : ''}">\${formatBigTimer(timeLeft)}</p>
                                    </div>
                                </div>

                                <div class="lg:order-3 mt-auto">
                                    <div class="flex justify-around items-center p-4 rounded-xl" style="background: \${COLORS.cardBackground};">
                                        <button id="play-pause-btn" class="p-4 rounded-full shadow-lg transition-all duration-300" style="background: \${isRunning ? COLORS.accentColor : COLORS.secondaryColor};">
                                            \${isRunning ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>'}
                                        </button>
                                        <button id="skip-btn" class="p-4 rounded-full shadow-lg ml-4 transition-colors" style="background: \${COLORS.cardBackground};">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                \`;
                container.innerHTML = playerHtml;

                document.getElementById('player-back-btn').addEventListener('click', () => navigateTo('detail', { workoutId: selectedWorkoutId }));
                document.getElementById('play-pause-btn').addEventListener('click', () => { isRunning = !isRunning; renderPlayerUI(); });
                document.getElementById('skip-btn').addEventListener('click', handleSkip);

                if (isRunning && !timerInterval) {
                    timerInterval = setInterval(updateTimer, 1000);
                }
            };

            const updateTimer = () => {
                if (!isRunning) return;
                totalTimeLeft--;
                const totalTimeDisplay = document.getElementById('total-time-display');
                if (totalTimeDisplay) totalTimeDisplay.textContent = formatTime(totalTimeLeft);
                timeLeft--;
                const isLastStep = currentStepIndex === currentWorkoutSteps.length - 1;
                
                if (timeLeft >= 1 && timeLeft <= 3) playTone(440);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if (!isLastStep) {
                        playTone(880, 0.2);
                        currentStepIndex++;
                        const nextStep = currentWorkoutSteps[currentStepIndex];
                        timeLeft = nextStep.duration;
                        initialTime = nextStep.duration;
                        renderPlayerUI();
                    } else {
                        playTone(880, 0.3);
                        setTimeout(() => {
                            playTone(880, 0.3);
                            setTimeout(() => playTone(880, 0.3), 200);
                        }, 200);
                        alert('Workout Complete! Great job!');
                        navigateTo('detail', { workoutId: selectedWorkoutId });
                    }
                } else {
                    const timerDisplay = document.getElementById('timer-display');
                    if (timerDisplay) {
                        timerDisplay.textContent = formatBigTimer(timeLeft);
                        timerDisplay.className = 'relative big-timer font-black ' + (timeLeft < 60 ? 'seconds-only' : '');
                    }
                    const progressCircle = document.getElementById('timer-progress-circle');
                    if (progressCircle) {
                        const circumference = 2 * Math.PI * 45;
                        const progress = initialTime > 0 ? (timeLeft / initialTime) * 100 : 0;
                        progressCircle.setAttribute('stroke-dashoffset', circumference * (1 - progress / 100));
                    }
                }
            };

            const handleSkip = () => {
                clearInterval(timerInterval);
                timerInterval = null;
                const isLastStep = currentStepIndex === currentWorkoutSteps.length - 1;
                if (!isLastStep) {
                    totalTimeLeft -= timeLeft;
                    currentStepIndex++;
                    const nextStep = currentWorkoutSteps[currentStepIndex];
                    timeLeft = nextStep.duration;
                    initialTime = nextStep.duration;
                    renderPlayerUI();
                } else {
                    alert('Workout Complete! Great job!');
                    navigateTo('detail', { workoutId: selectedWorkoutId });
                }
            };

            renderPlayerUI();
        };

        // Initialize
        renderApp();
    <\/script>

<div id="export-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
  <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-2xl shadow-xl">
    <h2 class="text-xl font-semibold text-white mb-4">Export Your Workout App</h2>
    <textarea id="export-html-code" class="w-full h-64 bg-gray-900 text-gray-300 p-3 rounded-lg border border-gray-700"></textarea>
    <div class="flex justify-end gap-3 mt-4">
      <button id="close-export-modal" class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600">Close</button>
      <button id="copy-export-code" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500">Copy</button>
      <button id="download-export-html" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500">Download</button>
    </div>
  </div>
</div>
</body>
</html>`;
        };

        // ==================== INITIALIZE ====================
        render();
    
// Copy exported HTML code
document.getElementById('copy-export-btn')?.addEventListener('click', async () => {
    const workouts = [];
    const processGroup = (group, groupName) => {
        group.workouts.forEach(w => {
            workouts.push({
                id: w.id,
                name: w.name,
                group: groupName,
                target: w.target,
                duration: calculateWorkoutDuration(w.exercises),
                icon: w.icon,
                exercises: w.exercises.map(e => ({
                    name: e.name,
                    type: e.type,
                    duration: e.duration,
                    videoUrl: e.videoUrl || '',
                    imageUrl: e.imageUrl || ''
                }))
            });
        });
        group.subGroups.forEach(sg => processGroup(sg, `${groupName} > ${sg.name}`));
    };
    state.groups.forEach(g => processGroup(g, g.name));
    const htmlText = generateExportedHTML(workouts);
    try {
        await navigator.clipboard.writeText(htmlText);
        alert("Code copied to clipboard!");
    } catch (err) {
        alert("Failed to copy.");
    }
});


// Modal handlers
const exportModal = document.getElementById('export-modal');
document.getElementById('export-modal-btn')?.addEventListener('click', () => {
    const workouts = [];
    const processGroup = (group, groupName) => {
        group.workouts.forEach(w => {
            workouts.push({
                id: w.id, name: w.name, group: groupName, target: w.target,
                duration: calculateWorkoutDuration(w.exercises),
                icon: w.icon,
                exercises: w.exercises.map(e => ({name: e.name, type: e.type, duration: e.duration, videoUrl: e.videoUrl||'', imageUrl: e.imageUrl||''}))
            });
        });
        group.subGroups.forEach(sg => processGroup(sg, `${groupName} > ${sg.name}`));
    };
    state.groups.forEach(g => processGroup(g, g.name));
    const html = generateExportedHTML(workouts);
    document.getElementById('export-html-code').value = html;
    exportModal.classList.remove('hidden');
});

document.getElementById('close-export-modal').onclick = () => exportModal.classList.add('hidden');

document.getElementById('copy-export-code').onclick = async () => {
    try { await navigator.clipboard.writeText(document.getElementById('export-html-code').value); alert("Copied!"); }
    catch(e){ alert("Copy failed"); }
};

document.getElementById('download-export-html').onclick = () => {
    const blob = new Blob([document.getElementById('export-html-code').value], {type:'text/html'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "workout_app.html";
    link.click();
};

</script>

<div id="export-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
  <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-2xl shadow-xl">
    <h2 class="text-xl font-semibold text-white mb-4">Export Your Workout App</h2>
    <textarea id="export-html-code" class="w-full h-64 bg-gray-900 text-gray-300 p-3 rounded-lg border border-gray-700"></textarea>
    <div class="flex justify-end gap-3 mt-4">
      <button id="close-export-modal" class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600">Close</button>
      <button id="copy-export-code" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500">Copy</button>
      <button id="download-export-html" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500">Download</button>
    </div>
  </div>
</div>
</body>
</html>
